# OpenAPI example

This example demonstrates how Orchestra can be used to support an OpenAPI specification for a REST API. The
[openapi.yaml](./openapi.yaml) file is used to describe the API itself, while a schemas.json file is generated from the Orchestra
specification to describe the underlying data model. Schemas from this file are then referenced from openapi.yaml.

An off-the-shelf OpenAPI documentation generator is then run to demonstrate one possible usage of the OpenAPI spec.

## Configuration

See [build.gradle](./build.gradle). 

As seen in [06-json-schema](../06-json-schema) a JSON schema is generated from the Orchestra spec.

```groovy
orchestra {
  specification {
    // spec derived from fix-latest
    markdown {
      reference orchestraHub(name: 'fix-latest', version: 'ep292')
      enableSpotless()
    }
    
    encoding {
      datatypeMapping([
        double: [
          JSON: 'number',
        ],
        string: [
          JSON: 'string',
        ],
        Pattern: [
          JSON: 'string',
        ],
      ])
    }
  }

  // Generate a JSON Schema for inclusion in the OpenAPI spec
  jsonSchema {
    namespace = 'org.example.orchestra'
  }
}
```
A custom task is added to colocate the two files so that the provided [openapi.yaml](./openapi.yaml) can easily reference 
Schemas from the JSON schema file that has been generated by the plugin and subsequently renamed.

```groovy
// Colocate the 
def colocateFiles = tasks.register('colocateOpenApiFiles', Copy) {
  from(orchestraGenerateJsonSchema) {
    rename { 'schemas.json' }
  }
  from 'openapi.yaml'

  into layout.buildDirectory.dir('tmp/openapi')
}
```
The last step is to configure an off-the-shelf OpenAPI documentation generator

```groovy
// Configure an off-the-shelf OpenAPI documentation generator
tasks.openApiGenerate {
  inputs.dir(colocateFiles.map { it.destinationDir })
  inputSpec = colocateFiles.map {it.destinationDir.toPath().resolve('openapi.yaml').toString() }
  generatorName = 'html2'
  outputDir = layout.buildDirectory.dir('openapi').get().toString()
}

```

## Run

To generate OpenAPI documentation for the FIX Latest Orchestra spec run

```
./gradlew :basic-examples:09-openapi:runExample
```
`runExample` is wired to call the `openApiGenerate` task in [build.gradle](./build.gradle).

## Results 

The OpenAPI documentation will be generated in the Gradle build folder. e.g.

```
./basic-examples/09-openapi/build/openapi/index.html
```
